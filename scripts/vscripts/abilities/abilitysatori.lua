abilityname={}
pet={}
ability_thdots_satori01 = {}
--可偷取技能表
ability_can_be_stolen ={
--rin
	"ability_thdots_rin01",
	"ability_thdots_rin02",
	"ability_thdots_rin03",
--exrumia
	"ability_thdots_exrumia01",
	"ability_thdots_exrumia02",
	"ability_thdots_exrumia03",
	"ability_thdots_exrumia04",
--rumia
	"ability_thdots_rumia04",
	"ability_thdots_rumia01",
--flandre2
	"ability_thdots_flandrev2_01",
	"ability_thdots_flandrev2_02",
	"ability_thdots_flandrev2_06",
--larva	
	"ability_thdots_larva01",
	"ability_thdots_larva02",
	"ability_thdots_larva03",
	"ability_thdots_larva04",
--miko
	"ability_thdots_miko01",
	"ability_thdots_miko02",
	"ability_thdots_miko04",
--kasen
	"ability_thdots_kasen01",
	"ability_thdots_kasen02",
	"ability_thdots_kasen03",
	"ability_thdots_kasen04",
--reimu
	"ability_dota2x_reimu01",
	"ability_dota2x_reimu02",
	"ability_dota2x_reimu03",
	"ability_dota2x_reimu04",
--marisa
	"ability_thdots_marisa01",
	"ability_thdots_marisa02",
	"ability_thdots_marisa04",
--youmu
	"ability_thdots_youmu01",
	"ability_thdots_youmu04",
--exyoumu			
	"ability_thdots_youmu2_01",
	"ability_thdots_youmu2_02",
--aya
	"aya_fantasy",
	"ability_thdots_aya01",
	"ability_thdots_aya02",
	"ability_thdots_aya04",
--tenshi
	"earthshaker_fissure",
	"ability_thdots_tensi03",
	"zuus_thundergods_wrath",
--byakuren
	"ability_thdots_byakuren01",
	"ability_thdots_byakuren02",
	"ability_thdots_byakuren03",
	"ability_thdots_byakuren05",
--yuyuko
	"ability_thdots_yuyuko01",
	"ability_thdots_yuyuko02",
	"ability_thdots_yuyuko04",
--sakuya
	"ability_thdots_sakuya01",
	"ability_thdots_sakuya02",
	"ability_thdots_sakuya03",
	"ability_thdots_sakuya04",
--flandre
	"ability_thdots_flandre01",
	"ability_thdots_flandre04",
--mokou
	"ability_thdots_mokou01",
	"ability_thdots_mokou04",
--yugi
	"centaur_hoof_stomp",
	"ability_thdots_yugi04",
--suika
	"tiny_toss",
	"ability_thdots_suika03",
	"ability_thdots_suika04",
--iku
	"ability_thdots_iku02",
	"ability_thdots_ikuEx",
--Utsuho
	"ability_thdots_Utsuho01",
	"ability_thdots_Utsuho02",
	"ability_thdots_Utsuho03",
	"ability_thdots_Utsuho04",
--eirin
	"disruptor_kinetic_field",
	"ability_thdots_eirin02",
	"ability_thdots_eirin03",
	"ability_thdots_eirinex",	
	"ability_thdots_eirin04",
--kaguya
	"ability_thdots_kaguya01",
	"ability_thdots_kaguya03",
--reisen
	"ability_thdots_reisenOld02",	
	"ability_thdots_reisenOld03",
	"ability_thdots_reisenOld04",
--sanae
	"ability_thdots_sanae01",
	"ability_thdots_sanae02",		
	"ability_thdots_sanae04",
--remilia
	"ability_thdots_remilia01",
	"ability_thdots_remilia02",
	"ability_thdots_remilia03",
	"ability_thdots_remilia04",
--shikieiki
	"ability_thdots_shikieiki01",
	"ability_thdots_shikieiki02",	
	"ability_thdots_shikieiki04",
--momiji
	"ability_thdots_momiji02",
	"ability_thdots_momiji03",
--wriggle
	"ability_thdots_wriggle01",
	"wriggle_exorcism",
--yumemi
	"ability_thdots_yumemi01",
	"ability_thdots_yumemi02",
	"ability_thdots_yumemi03",
	"ability_thdots_yumemi04",
--cirno
	"ability_thdots_cirno01",
	"ability_thdots_cirno02",
	"ability_thdots_cirno03",
	"ability_thdots_cirno04",
--yasaka
	"ability_thdots_yasaka01",
	"ability_thdots_yasaka02",
	"ability_thdots_yasaka03",		
--minamitsu
	"ability_thdots_minamitsu01",
	"ability_thdots_minamitsu02",
	"ability_thdots_minamitsu03",		
--yukari
	"ability_thdots_yukari01",
	"ability_thdots_yukari02",
	"ability_thdots_yukari03",		
--ran
	"ability_thdots_ran01",
	"ability_thdots_ran02",
	"ability_thdots_ran03",
	"ability_thdots_RanEx",
	"ability_thdots_ran04",
--yuuka
	"ability_thdots_yuuka01",
	"ability_thdots_yuuka02",
	"ability_thdots_yuuka03",		
--Margatroid
	"ability_thdots_Margatroid03",
--minoriko
	"ability_thdots_minoriko01",
	"ability_thdots_minoriko02",
	"ability_thdots_minoriko04",
--nue
	"ability_thdots_nue02",
	"ability_thdots_nue04",
--patchouli
	"ability_thdots_patchouli_fire_fire",
	"ability_thdots_patchouli_fire_water",
	"ability_thdots_patchouli_fire_wood",
	"ability_thdots_patchouli_fire_metal",
	"ability_thdots_patchouli_fire_earth",
	"ability_thdots_patchouli_water_water",
	"ability_thdots_patchouli_water_wood",
	"ability_thdots_patchouli_water_metal",
	"ability_thdots_patchouli_water_earth",
	"ability_thdots_patchouli_wood_wood",
	"ability_thdots_patchouli_wood_metal",
	"ability_thdots_patchouli_wood_earth",
	"ability_thdots_patchouli_metal_metal",
	"ability_thdots_patchouli_metal_earth",
	"ability_thdots_patchouli_earth_earth",
--komachi
	"ability_thdots_komachi01",
	"ability_thdots_komachi04",
--kurumi
	"ability_thdots_kurumi01",
	"ability_thdots_kurumi02",
--medicine
	"ability_thdots_medicine01",
	"ability_thdots_medicine02",
	"ability_thdots_medicine03",
	"ability_thdots_medicine04",
--clown
	"ability_thdots_clown01",
	"ability_thdots_clown02",
	"ability_thdots_clown03",
	"ability_thdots_clown04",
--koakuma
	"ability_thdots_koakuma01",
	"ability_thdots_koakuma02",		
--lunasa
	"ability_thdots_lunasa01",
	"ability_thdots_lunasa04",
--meirin
	"ability_thdots_meirin01",
	"ability_thdots_meirin02",
	"ability_thdots_meirin04_fix",
--lyric
	"ability_thdots_lyrica01",
	"ability_thdots_lyrica02",
	"ability_thdots_lyrica04",
--shou
	"ability_thdots_shou01",
	"ability_thdots_shou02",
	"ability_thdots_shou04",
--child
	"ability_thdots_child01",
	"ability_thdots_child02",
	"ability_thdots_child04",
--Merlin
	"ability_thdots_Merlin01",
	"ability_thdots_Merlin02",
	"ability_thdots_Merlin04",
--mystia
	"ability_thdots_mystia01",
	"ability_thdots_mystia02",
	"ability_thdots_mystiaex",
	"ability_thdots_mystia04",
--hatate
	"ability_thdots_hatate01",
	"ability_thdots_hatate02",
	"ability_thdots_hatate03",
	"ability_thdots_hatateEx",
	"ability_thdots_hatate04",
--kogasa
	"ability_thdots_kogasa01",
	"ability_thdots_kogasa02",
	"ability_thdots_kogasa03",
	"ability_thdots_kogasa04",
--te
	"ability_thdots_tei01",
	"ability_thdots_tei02",
	"ability_thdots_tei03",
	"ability_thdots_tei04",
--nitori
	"ability_thdots_nitori01",
	"ability_thdots_nitori02",
	"ability_thdots_nitori03",
	"ability_thdots_nitori04",
--kokoro
	"ability_thdots_kokoro01",
	"ability_thdots_kokoro02",
	"ability_thdots_kokoro03",
	"ability_thdots_kokoro04",
--reisen2
	"ability_thdots_reisen_2_01",
	"ability_thdots_reisen_2_02",
	"ability_thdots_reisen_2_ultimate",
--hina
	"ability_thdots_hina01",
	"ability_thdots_hina02",
	"ability_thdots_hina03",
	"ability_thdots_hina04",
--kagerou
	"ability_thdots_kagerou01",
	"ability_thdots_kagerou02",
	"ability_thdots_kagerou03",
	"ability_thdots_kagerou06",
--seija
	"ability_thdots_seija01",
	"ability_thdots_seija02",
	"ability_thdots_seija03",
	"ability_thdots_seija04",
--lily
	"ability_thdots_lily01_lua",
	"ability_thdots_lily02",
	"ability_thdots_lily03",
	"ability_thdots_lily04",
--Nazrin
	"ability_thdotsr_Nazrin01",
	"ability_thdotsr_Nazrin02",
	"ability_thdotsr_Nazrin04",
--star
	"ability_thdotsr_star01",
	"ability_thdotsr_star02",
	"ability_thdotsr_star03",
--yorihime
	"ability_thdots_yorihime_01",
	"ability_thdots_yorihime_02",
	"ability_thdots_yorihime_03",
	"ability_thdots_yorihime_ultimate",
--sunny
	"ability_thdots_sunny01",
	"ability_thdots_sunny02",
	"ability_thdots_sunny03",
	"ability_thdots_sunny04",
--chen
	"ability_thdots_chen01",
	"ability_thdots_chen02",
	"ability_thdots_chen03",
	"ability_thdots_chen04",
--suwako
	"ability_thdots_suwako01",
	"ability_thdots_suwako02",
	"ability_thdots_suwako03z",
	"ability_thdots_suwako04new",
--shinki
	"ability_thdots_shinki_01",
	"ability_thdots_shinki_02",
	"ability_thdots_shinki_03",
	"ability_thdots_shinki_ultimate",
--sumireko
	"ability_thdots_sumireko01",
	"ability_thdots_sumireko02",
	"ability_thdots_sumireko03",
	"ability_thdots_sumireko04",
--yamame
	"ability_thdots_yamame03",
	"ability_thdots_yamame04",
--daiyousei
	"ability_thdots_daiyousei01",
	"ability_thdots_daiyousei02",
	"ability_thdots_daiyousei03",
	"ability_thdots_daiyousei04",
--keine
	"ability_thdots_keine01",
	"ability_thdots_keine02",
	"ability_thdots_keine03",
	"ability_thdots_keine04",
--letty
	"ability_thdots_letty01",
	"ability_thdots_letty02",
	"ability_thdots_letty02",
	"ability_thdots_letty04",
--parsee
	"ability_thdots_parsee01",
	"ability_thdots_parsee02",
	"ability_thdots_parsee03",
	"ability_thdots_parsee04",
--tojiko
	"ability_thdots_tojiko01",
	"ability_thdots_tojiko02",
	"ability_thdots_tojiko03",
	"ability_thdots_tojiko04",
--kisume
	"ability_thdots_kisume01",
	"ability_thdots_kisume02",
	"ability_thdots_kisume03",
	"ability_thdots_kisume04",
--ellen
	"ability_thdots_ellen01",
	"ability_thdots_ellen02",
	"ability_thdots_ellen03",
	"ability_thdots_ellen04",
--seiga
	"ability_thdots_seiga01",
	"ability_thdots_seiga02",
	"ability_thdots_seiga03",
	"ability_thdots_seiga04",
--miyako
	"ability_thdots_miyako01",
	"ability_thdots_miyako04",
--shizuha
	"ability_thdots_shizuha01",
	"ability_thdots_shizuha02",
	"ability_thdots_shizuha04",
--mikov2
	"ability_thdots_miko2_1",
	"ability_thdots_miko2_2",
	"ability_thdots_miko2_3",
	"ability_thdots_miko2_4",
--shion
	"ability_thdots_shion_01",
	"ability_thdots_shion_02",
--sagume
	"ability_thdots_sagume_1",
	"ability_thdots_sagume_2",
	"ability_thdots_sagume_4",
--jyoon
	"ability_thdots_Jyoon_2",
	"ability_thdots_Jyoon_3",
	"ability_thdots_Jyoon_4",
--meira
	"ability_thdots_meira01_1",
	"ability_thdots_meira01_2",
	"ability_thdots_meira01_3",
	"ability_thdots_meira02",
	"ability_thdots_meira03",
	"ability_thdots_meira05",
	"ability_thdots_meira04_1",
	"ability_thdots_meira04_2",
}

function AbilityCanBeStolen(ability_name)
	for _,name in pairs(ability_can_be_stolen) do
		if name == ability_name then return true end
	end
end

function ability_thdots_satori01:GetIntrinsicModifierName()
	return "modifier_ability_thdots_satori01_target"
end

modifier_ability_thdots_satori01_target = {}
LinkLuaModifier("modifier_ability_thdots_satori01_target","scripts/vscripts/abilities/abilitysatori.lua",LUA_MODIFIER_MOTION_NONE)
function modifier_ability_thdots_satori01_target:IsHidden() 		return true end
function modifier_ability_thdots_satori01_target:IsPurgable()		return false end
function modifier_ability_thdots_satori01_target:RemoveOnDeath() 	return false end
function modifier_ability_thdots_satori01_target:IsDebuff()		return false end

function modifier_ability_thdots_satori01_target:DeclareFunctions()
	return
	{
		MODIFIER_EVENT_ON_ABILITY_EXECUTED,
	}
end

function modifier_ability_thdots_satori01_target:OnAbilityExecuted(event)
	if not IsServer() then return end
	self.caster = self:GetCaster()
	self.ability = self:GetAbility()
	if self.ability.satori_stolen_name == nil then self.ability.satori_stolen_name = {} end
	--print("unit "..event.unit:GetClassname())
	--print("caster "..self:GetCaster():GetClassname())
	if event.unit:GetTeam() == self:GetCaster():GetTeam() then 
		--print("==")
		return
	else
		--print("~=")
		local target_ability = event.ability --释放的技能
		local target_ability_name = target_ability:GetAbilityName() --释放的技能名
		if AbilityCanBeStolen(target_ability_name)~=true then print("cant be stolen") return end
		local target_name = event.unit:GetClassname()
		--print("target_name "..target_name)
		self.ability.satori_stolen_name[target_name] = target_ability_name --储存偷取的技能名，索引为目标名
		--print(self.ability.satori_stolen_name[target_name])
	end
	--caster:AddNewModifier(caster, self, "modifier_ability_thdots_miyako04_active", {duration = delay_time})
end

function ability_thdots_satori01:OnSpellStart()
	local target = self:GetCursorTarget()
	local caster = self:GetCaster()
	local TargetName = target:GetClassname()
	local steal_duration = self:GetSpecialValueFor("steal_duration")
	local duration = self:GetSpecialValueFor("duration")
	--print("target "..self:GetCursorTarget():GetClassname())
	--print(self.satori_stolen_name[self:GetCursorTarget():GetClassname()])
	self:ForgetSpell(caster)--修饰器移除
	------------------------------------------------------
	caster:EmitCasterSound("npc_dota_hero_rubick",{"thdots_satori_ability01_01"}, 70, DOTA_CAST_SOUND_FLAG_BOTH_TEAMS, 5, "satori01")
	caster:EmitSound("Hero_Rubick.SpellSteal.Cast.Arcana")

	if target:IsRealHero()==false or self.satori_stolen_name[TargetName] == nil then
		self:RefundManaCost()
		self:EndCooldown()
		return
	end

	if TargetName == "npc_dota_hero_drow_ranger" then return end

	if(caster.sakuya04_cooldown_reset==TRUE)then--咲夜大招特例
		self:EndCooldown()
		local usedCount = caster.sakuya04_ability_01_used_count + 1
		caster:SetMana(caster:GetMana() - usedCount * 0.25 * self:GetManaCost(self:GetLevel()))
		caster.sakuya04_ability_01_used_count = usedCount
	end

	if self.oldSpellname == nil then self.oldSpellname = "rubick_empty1" end --记录原技能名字，默认为拉比克空位
	if self.currentSpell == nil then self.currentSpell = caster:FindAbilityByName("rubick_empty1") end --记录原技能，默认为拉比克空位
	if self.oldSpell == nil then self.oldSpell = caster:FindAbilityByName("rubick_empty1") end	-- handle

	local AbilityStolenName = self.satori_stolen_name[TargetName]--记录被偷取的单位的最后使用技能的名字
	local AbilityLevel = target:FindAbilityByName(AbilityStolenName):GetLevel()--获取被偷取技能的等级

	-- 旧子技能
	local OldSecondaryAbilityName = self.oldSpell:GetAssociatedSecondaryAbilities()

	if self.oldSpellname == AbilityStolenName then
		--如果偷取技能与原技能一致,--刷新偷取技能的持续时间
		self:GetCaster():FindModifierByName("modifier_thdots_satori01_time_up"):SetDuration(steal_duration, true)
		self.currentSpell:SetLevel(AbilityLevel)
		print("same spell")
	else
		--否则与原技能交换并修改原技能，先修改原技能为新技能，后用旧技能名与新技能名进行交换，移除旧技能
		self.currentSpell = caster:AddAbility(AbilityStolenName)
		self.currentSpell:SetStolen( true )
		self.currentSpell:SetLevel(AbilityLevel)

		-- 复位
		if self.oldSpell:IsHidden() and OldSecondaryAbilityName then
			caster:SwapAbilities(self.oldSpellname, OldSecondaryAbilityName, true, false)
		end

		caster:SwapAbilities(AbilityStolenName, self.oldSpellname, true, false)

		-- 添加子技能
		local SecondaryAbilityName = self.currentSpell:GetAssociatedSecondaryAbilities()
		if SecondaryAbilityName then
			local secondaryAbility = caster:AddAbility(SecondaryAbilityName)
			secondaryAbility:SetStolen( true )

			local secAbilityLevel = target:FindAbilityByName(SecondaryAbilityName):GetLevel()
			secondaryAbility:SetLevel(secAbilityLevel)
		end

		-- 移除旧技能
		if self.oldSpellname ~= "rubick_empty1" then --原技能是空位的话不移除
			caster:RemoveAbility(self.oldSpellname)

			-- 移除旧子技能
			if OldSecondaryAbilityName then
				caster:RemoveAbility(OldSecondaryAbilityName)
			end
		end

		self.oldSpellname = AbilityStolenName
		self.oldSpell = self.currentSpell
		self:GetCaster():AddNewModifier(self:GetCaster(), self, "modifier_thdots_satori01_time_up", {duration = steal_duration,abilityname = AbilityStolenName})
	end

	local effectIndex = ParticleManager:CreateParticle("particles/units/heroes/hero_bloodseeker/bloodseeker_bloodrage.vpcf", PATTACH_CUSTOMORIGIN, caster)
		ParticleManager:SetParticleControlEnt(effectIndex , 0, caster, 5, "follow_origin", Vector(0,0,0), true)
		ParticleManager:SetParticleControl(effectIndex, 1, caster:GetOrigin())
		ParticleManager:DestroyParticleSystemTime(effectIndex,2)
end
modifier_thdots_satori01_time_up = {}
LinkLuaModifier("modifier_thdots_satori01_time_up","scripts/vscripts/abilities/abilitysatori.lua",LUA_MODIFIER_MOTION_NONE)
function modifier_thdots_satori01_time_up:IsHidden() 		return false end
function modifier_thdots_satori01_time_up:IsPurgable()		return false end
function modifier_thdots_satori01_time_up:RemoveOnDeath() 	return false end
function modifier_thdots_satori01_time_up:IsDebuff()		return false end
function modifier_thdots_satori01_time_up:OnCreated(keys)
	if not IsServer() then return end
	self.abilityname = keys.abilityname
end
function modifier_thdots_satori01_time_up:OnRefresh(keys)
	if not IsServer() then return end
	self.abilityname = keys.abilityname
end
function modifier_thdots_satori01_time_up:OnDestroy()--持续时间结束后，把技能交换回来再移除
	if not IsServer() then return end

	local caster = self:GetCaster()
	local ability = caster:FindAbilityByName(self.abilityname)

	local secondaryAbilityName = ability:GetAssociatedSecondaryAbilities()

	-- 复位
	if ability:IsHidden() and secondaryAbilityName then
		caster:SwapAbilities(self.abilityname, secondaryAbilityName, true, false)
	end

	self:GetCaster():SwapAbilities("rubick_empty1", self.abilityname, true,false )
	caster:RemoveAbility(self.abilityname)

	if secondaryAbilityName then
		caster:RemoveAbility(secondaryAbilityName)
	end

	self:GetAbility().oldSpellname = "rubick_empty1"
	self:GetAbility().currentSpell = caster:FindAbilityByName("rubick_empty1")
	self:GetAbility().oldSpell = caster:FindAbilityByName("rubick_empty1")
end


function OnSatori02SpellStart(keys)
	local caster = keys.caster
	local target = keys.target
	local targetPoint = target:GetOrigin()	
	if(caster.sakuya04_cooldown_reset==TRUE)then
		keys.ability:EndCooldown()
		local usedCount = caster.sakuya04_ability_01_used_count + 1
		caster:SetMana(caster:GetMana() - usedCount * 0.25 * keys.ability:GetManaCost(keys.ability:GetLevel()))
		caster.sakuya04_ability_01_used_count = usedCount
	end
	if is_spell_blocked(target) then return end
	local targets = FindUnitsInRadius(
		   caster:GetTeam(),		--caster team
		   targetPoint,				--find position
		   nil,						--find entity
		   keys.Radius,				--find radius
		   DOTA_UNIT_TARGET_TEAM_ENEMY,
		   keys.ability:GetAbilityTargetType(),
		   0, FIND_CLOSEST,
		   false
	)
	for k,v in pairs(targets) do
		keys.ability:ApplyDataDrivenModifier(caster, v, "modifier_thdots_satori02", {Duration = keys.Duration})
		keys.ability:ApplyDataDrivenModifier(caster, v, "modifier_thdots_satori02_think", {Duration = keys.Duration})
		if v:HasModifier("modifier_thdots_satori04_bonus_damage") then
		UtilStun:UnitStunTarget( caster, v, keys.Duration)
		end	
	end	
	
end

function OnSatori02SpellThink(keys)
	local caster = keys.caster
	local target = keys.target
	local damage_target = {
		victim = keys.target,
		attacker = caster,
		damage = (keys.ability:GetAbilityDamage() + FindTelentValue(caster,"special_bonus_unique_satori_3"))/3,
		damage_type = keys.ability:GetAbilityDamageType(), 
	    damage_flags = 0
	}
	UtilStun:UnitStunTarget( caster, target, 0.3)
	UnitDamageTarget(damage_target)
end

ability_thdots_satori03 = {}

function ability_thdots_satori03:GetIntrinsicModifierName()
	return "modifier_ability_thdots_satori03_passive"
end

function ability_thdots_satori03:OnSpellStart()
	if not IsServer() then return end
	local caster = self:GetCaster()
	local target = self:GetCursorTarget()
	local MaxNum = self:GetSpecialValueFor("max_num")
	local MaxHealth = self:GetSpecialValueFor("max_health")
	local vec = target:GetOrigin()
	if(caster.sakuya04_cooldown_reset==TRUE)then
		self:EndCooldown()
		local usedCount = caster.sakuya04_ability_01_used_count + 1
		caster:SetMana(caster:GetMana() - usedCount * 0.25 * self:GetManaCost(self:GetLevel()))
		caster.sakuya04_ability_01_used_count = usedCount
	end
	target:EmitSound("Hero_Warlock.ShadowWordCastGood")
	local PetName = target:GetUnitName()
	--print(PetName)
	if target:IsAncient()==true and FindTelentValue(caster,"special_bonus_unique_satori_1")==0 then 
		 self:EndCooldown()
		 self:RefundManaCost()
		 return
	elseif PetName=="npc_thdots_unit_minoriko02_box" then 
		 self:EndCooldown()
		 self:RefundManaCost()
		 return
	elseif PetName=="ability_minamitsu_04_ship" then 
		 self:EndCooldown()
		 self:RefundManaCost()
		 return
	elseif PetName=="ability_momiji_Spawn_unit" then 
		 self:EndCooldown()
		 self:RefundManaCost()
		 return
	elseif PetName=="ability_margatroid03_doll" then 
		 self:EndCooldown()
		 self:RefundManaCost()
		 return
	elseif PetName=="npc_dota_suika_03_smallsuika" then 
		 self:EndCooldown()
		 self:RefundManaCost()
		 return		 
	elseif PetName=="ability_margatroidex_doll" then 
		 self:EndCooldown()
		 self:RefundManaCost()
		 return	 
	elseif (target:GetClassname()=="npc_dota_roshan") then 
		 self:EndCooldown()
		 self:RefundManaCost()
		return
	elseif target:HasModifier("modifier_ability_thdots_super_siege") then
		 self:EndCooldown()
		 self:RefundManaCost()
		return
	elseif target:GetUnitName() == "ability_star03_ward" then
		 self:EndCooldown()
		 self:RefundManaCost()
		return
	end
	if target:GetOwner()==caster then 
		target:SetHealth(target:GetMaxHealth())
		return
	end
	target:Kill(self, caster)
	local unit = CreateUnitByName(
			PetName
			,vec
			,false
			,caster
			,caster
			,caster:GetTeam()
		)
	unit:SetControllableByPlayer(caster:GetPlayerOwnerID(), true) 
	unit:AddNewModifier(caster, self, "modifier_thdots_unit_anti_bd", {})
	unit:AddNewModifier(caster, self, "modifier_ability_thdots_satori03_attack_bonus",{})
	ResolveNPCPositions(unit:GetAbsOrigin(), 128)
	if unit:GetMaxHealth() < MaxHealth then
		unit:SetBaseMaxHealth(MaxHealth)
	end
	unit:AddNewModifier(caster, self, "refresh_mod", {duration = 0.03})  --刷新状态
	if self.pet == nil then self.pet={} end
	if self.petNum == nil then self.petNum = 0 end
	if self.petNum == MaxNum then
		self.pet[1]:ForceKill(false)
		table.remove(self.pet,1)
		self.petNum = self.petNum - 1
	end
	self.petNum = self.petNum + 1
	self.pet[self.petNum] = unit
end

modifier_ability_thdots_satori03_passive = {}
LinkLuaModifier("modifier_ability_thdots_satori03_passive","scripts/vscripts/abilities/abilitysatori.lua",LUA_MODIFIER_MOTION_NONE)
function modifier_ability_thdots_satori03_passive:IsHidden() return true end
function modifier_ability_thdots_satori03_passive:IsPurgable() return false end
function modifier_ability_thdots_satori03_passive:RemoveOnDeath() return false end
function modifier_ability_thdots_satori03_passive:IsDebuff() return false end

function modifier_ability_thdots_satori03_passive:DeclareFunctions()
	return {
		MODIFIER_EVENT_ON_DEATH
	}
end

function modifier_ability_thdots_satori03_passive:OnDeath(event)
	if not IsServer() then return end

	local unit = event.unit
	local ability = self:GetAbility()
	if ability == nil or ability.pet == nil or ability.petNum == nil then
		return
	end

	local index = 0
	for i = 1, ability.petNum do
		if unit == ability.pet[i] then
			index = i
			break
		end
	end
	if index == 0 then return end

	for i = index, ability.petNum - 1 do
		ability.pet[i] = ability.pet[i + 1]
	end
	ability.pet[ability.petNum] = nil
	ability.petNum = ability.petNum - 1
end

refresh_mod = {}
LinkLuaModifier("refresh_mod", "scripts/vscripts/abilities/abilitysatori.lua", LUA_MODIFIER_MOTION_NONE)
function refresh_mod:IsHidden() return true end

modifier_thdots_unit_anti_bd = {}
LinkLuaModifier("modifier_thdots_unit_anti_bd", "scripts/vscripts/abilities/abilitysatori.lua", LUA_MODIFIER_MOTION_NONE)
function modifier_thdots_unit_anti_bd:IsHidden() return false end
function modifier_thdots_unit_anti_bd:IsPurgable() return false end
function modifier_thdots_unit_anti_bd:RemoveOnDeath() return true end

modifier_ability_thdots_satori03_attack_bonus = {}
LinkLuaModifier("modifier_ability_thdots_satori03_attack_bonus","scripts/vscripts/abilities/abilitysatori.lua",LUA_MODIFIER_MOTION_NONE)
function modifier_ability_thdots_satori03_attack_bonus:IsHidden() 		return true end
function modifier_ability_thdots_satori03_attack_bonus:IsPurgable()		return false end
function modifier_ability_thdots_satori03_attack_bonus:RemoveOnDeath() 	return true end
function modifier_ability_thdots_satori03_attack_bonus:IsDebuff()		return false end

function modifier_ability_thdots_satori03_attack_bonus:DeclareFunctions()
	return {
		MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
	}
end


function modifier_ability_thdots_satori03_attack_bonus:GetModifierPreAttack_BonusDamage()
	return self:GetAbility():GetSpecialValueFor("attack_bonus")
end


function OnSatori04SpellStart(keys)	
  	local caster = keys.caster
	local target = keys.target
  	local targets = FindUnitsInRadius(
		  caster:GetTeam(),		--caster team
		  caster:GetAbsOrigin(),				--find position
		  nil,						--find entity
		  keys.ability:GetSpecialValueFor("radius") + FindTelentValue(caster,"special_bonus_unique_satori_2"),				--find radius
		  DOTA_UNIT_TARGET_TEAM_ENEMY,
		  keys.ability:GetAbilityTargetType(),
		  0, FIND_CLOSEST,
		  false
	)
  	caster:EmitCasterSound("npc_dota_hero_rubick",{"thdots_satori_ability04_01"}, 100, DOTA_CAST_SOUND_FLAG_BOTH_TEAMS, 5, "satori04")
  	if(caster.sakuya04_cooldown_reset==TRUE)then
  		keys.ability:EndCooldown()
  		local usedCount = caster.sakuya04_ability_01_used_count + 1
  		caster:SetMana(caster:GetMana() - usedCount * 0.25 * keys.ability:GetManaCost(keys.ability:GetLevel()))
  		caster.sakuya04_ability_01_used_count = usedCount
  	end
	for k,v in pairs(targets) do
		keys.ability:ApplyDataDrivenModifier(caster, v, "modifier_thdots_satori04", {Duration = keys.Duration}) --特效
		keys.ability:ApplyDataDrivenModifier(caster, v, "modifier_thdots_satori04_think", {Duration = keys.Duration}) --易伤
		local effectIndex = ParticleManager:CreateParticle("particles/units/heroes/hero_dazzle/dazzle_shadow_wave.vpcf", PATTACH_CUSTOMORIGIN, nil)
  		ParticleManager:SetParticleControl(effectIndex, 0, caster:GetOrigin()+Vector(0, 0, 100))
  		ParticleManager:SetParticleControl(effectIndex, 1, v:GetOrigin()+Vector(0, 0, 100))
		if v:HasModifier("modifier_thdots_satori04_think") then 
			local target_modifier = keys.ability:ApplyDataDrivenModifier(caster, v, "modifier_thdots_satori04_bonus_damage", {Duration = keys.ability:GetSpecialValueFor("bonus_damage_Duration")})
			local effectIndex = ParticleManager:CreateParticle("particles/units/heroes/hero_dazzle/dazzle_shadow_wave.vpcf", PATTACH_CUSTOMORIGIN, nil)
			ParticleManager:SetParticleControl(effectIndex, 0, caster:GetOrigin()+Vector(0, 0, 100))
			ParticleManager:SetParticleControl(effectIndex, 1, v:GetOrigin()+Vector(0, 0, 100))
			if FindTelentValue(caster,"special_bonus_unique_satori_4")~=0 then
				local stealhp=v:GetMaxHealth()*FindTelentValue(caster,"special_bonus_unique_satori_4")
				local stealmana=v:GetMaxMana()*FindTelentValue(caster,"special_bonus_unique_satori_4")
				if v:GetHealth()>stealhp then
					v:SetHealth(v:GetHealth()-stealhp)
					caster:Heal(stealhp,caster)
				else
					caster:Heal(v:GetHealth(),caster)
					v:Kill(keys.ability,caster)
				end
				if v:GetMana()>stealmana then
					v:SetMana(v:GetMana()-stealmana)
					caster:GiveMana(stealmana)
				else
					caster:GiveMana(v:GetMana())
					v:SetMana(0)
				end
			end
		end
		v:SetModifierStackCount("modifier_thdots_satori04_bonus_damage", keys.ability, keys.ability:ApplyDataDrivenModifier(caster, v , "modifier_thdots_satori04_bonus_damage", {Duration = keys.ability:GetSpecialValueFor("bonus_damage_Duration")}):GetStackCount() + 1)
	end
  end
  
  function OnSatori04Think(keys)
	local caster = keys.caster
	local target = keys.target
	local Duration = keys.ability:GetSpecialValueFor("debuff_duration")

	if caster:IsAlive() and target:IsAlive() and target:HasModifier("modifier_thdots_satori04_think") then 
		local distance = GetDistanceBetweenTwoVec2D(target:GetOrigin(),caster:GetOrigin())
		if distance <= keys.Radius + FindTelentValue(caster,"special_bonus_unique_satori_2") then 
			target:SetModifierStackCount("modifier_thdots_satori04_bonus_damage", keys.ability, keys.ability:ApplyDataDrivenModifier(caster, target, "modifier_thdots_satori04_bonus_damage", {Duration = keys.ability:GetSpecialValueFor("bonus_damage_Duration")}):GetStackCount() + 1)
			local target_modifier = keys.ability:ApplyDataDrivenModifier(caster, target, "modifier_thdots_satori04_bonus_damage", {Duration = keys.ability:GetSpecialValueFor("bonus_damage_Duration")})
			local effectIndex = ParticleManager:CreateParticle("particles/units/heroes/hero_dazzle/dazzle_shadow_wave.vpcf", PATTACH_CUSTOMORIGIN, nil)
			ParticleManager:SetParticleControl(effectIndex, 0, caster:GetOrigin()+Vector(0, 0, 100))
			ParticleManager:SetParticleControl(effectIndex, 1, target:GetOrigin()+Vector(0, 0, 100))
			if FindTelentValue(caster,"special_bonus_unique_satori_4")~=0 then
				local stealhp=target:GetMaxHealth()*FindTelentValue(caster,"special_bonus_unique_satori_4")
				local stealmana=target:GetMaxMana()*FindTelentValue(caster,"special_bonus_unique_satori_4")
				if target:GetHealth()>stealhp then
					target:SetHealth(target:GetHealth()-stealhp)
					caster:Heal(stealhp,caster)
				else
					caster:Heal(target:GetHealth(),caster)
					target:Kill(keys.ability,caster)
				end
				if target:GetMana()>stealmana then
					target:SetMana(target:GetMana()-stealmana)
					caster:GiveMana(stealmana)
				else
					caster:GiveMana(target:GetMana())
					target:SetMana(0)
				end
			end
		end
	end
end
function ability_thdots_satori01:ForgetSpell(caster)
	--删除旧技能的MODIFIER
	--miko2
	caster:RemoveModifierByName("modifier_ability_miko2_1check")
	caster:RemoveModifierByName("modifier_ability_miko2_1ball")
	caster:RemoveModifierByName("modifier_ability_miko2_3passive")
	--exrumia
	caster:RemoveModifierByName("modifier_ability_exrumia04_wanbaochui")
	--rumia
	caster:RemoveModifierByName("modifier_ability_thdots_rumia04_strength")
	--flandre2
	caster:RemoveModifierByName("modifier_ability_thdots_flandrev2_02_attackrange")
	caster:RemoveModifierByName("modifier_ability_thdots_flandrev2_06_passive")
	--miko
	caster:RemoveModifierByName("modifier_ability_miko02_aura")
	caster:RemoveModifierByName("modifier_ability_miko02_check")
	--kasen
	caster:RemoveModifierByName("kasen01_passive")
	caster:RemoveModifierByName("passive_kasen02")
	caster:RemoveModifierByName("passive_kasen03")
	caster:RemoveModifierByName("passive_kasen03_aura")
	caster:RemoveModifierByName("passive_kasen03_check_aura")
	--shion
	caster:RemoveModifierByName("modifier_ability_thdots_shion_01_caster")
	caster:RemoveModifierByName("modifier_ability_thdots_shion_01_caster_debuff")
	caster:RemoveModifierByName("modifier_ability_thdots_shion_02_caster")
	caster:RemoveModifierByName("modifier_ability_thdots_shion_02_caster_debuff")
	caster:RemoveModifierByName("modifier_ability_thdots_shion_02_caster_passive")

	caster:RemoveModifierByName("passive_reisenOld02_attack")
	caster:RemoveModifierByName("modifier_thdots_aya04_speedbonus")
	caster:RemoveModifierByName("passive_flandre04_Refresh")
	caster:RemoveModifierByName("modifier_thdots_Remilia04_think_interval")
	caster:RemoveModifierByName("modifier_thdots_medicine03_onattacked")
	caster:RemoveModifierByName("modifier_thdots_komachi_blink")
	caster:RemoveModifierByName("modifier_thdots_kaguya03_mana_regen")
	caster:RemoveModifierByName("modifier_medicine01_arrow")
	caster:RemoveModifierByName("passive_tensi03_attacked")
	caster:RemoveModifierByName("modifier_clown03_passive")
	caster:RemoveModifierByName("modifier_thdots_Utsuho02_mana_regen")
	caster:RemoveModifierByName("ability_reisenold03_animation")
	caster:RemoveModifierByName("ability_reisenold03_modifier")
	caster:RemoveModifierByName("modifier_thdots_reisen03_time")
	caster:RemoveModifierByName("modifier_ability_thdots_shou02")
	caster:RemoveModifierByName("modifier_mystiaEx")
	caster:RemoveModifierByName("modifier_ability_thdots_hatate01")
	caster:RemoveModifierByName("modifier_ability_thdots_nitori03")
	if caster:HasModifier("modifier_kagerou_add_damage") then
		caster:RemoveModifierByName("modifier_kagerou_add_damage")
		--print("doit")
	end
	caster:RemoveModifierByName("modifier_ability_thdots_kagerou03")
	caster:RemoveModifierByName("modifier_ability_thdots_chen03")
	caster:RemoveModifierByName("modifier_suwako03_return_mana")
	caster:RemoveModifierByName("modifier_ability_thdots_keine03_passive")
	caster:RemoveModifierByName("modifier_ability_thdots_momiji03_passvie")
	caster:RemoveModifierByName("modifier_ability_thdots_parsee01_passive")
	caster:RemoveModifierByName("modifier_suwako03shield")
	caster:RemoveModifierByName("modifier_suwako03shield_manacheck")
	caster:RemoveModifierByName("modifier_suwako03_return_mana")
	caster:RemoveModifierByName("modifier_ability_thdots_kisume03_passive")
	caster:RemoveModifierByName("modifier_ability_thdots_nitori03")
	caster:RemoveModifierByName("modifier_ability_thdots_miyako01_caster")
	caster:RemoveModifierByName("modifier_ability_thdots_miyako04_passive")
	caster:RemoveModifierByName("modifier_ability_thdots_youmu2_02_passive")
	caster:RemoveModifierByName("modifier_ability_thdots_Jyoon_2_wanbaochui")
	----------------------------------------------------下面是DOTA2的BUFF
	caster:RemoveModifierByName("modifier_medusa_mana_shield")
	caster:RemoveModifierByName("modifier_leshrac_pulse_nova")
	caster:RemoveModifierByName("modifier_voodoo_restoration_aura")
end